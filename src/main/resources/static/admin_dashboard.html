<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gourmet Admin Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Animations */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
        
        @keyframes bounce-in {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-bounce-in { animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Sidebar Transition */
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen overflow-hidden flex selection:bg-orange-100 selection:text-orange-600">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-slate-900 text-white flex flex-col shadow-2xl sidebar-transition -translate-x-full md:relative md:translate-x-0">
        <div class="p-6 flex items-center space-x-3 border-b border-slate-700">
            <div class="bg-gradient-to-br from-orange-500 to-red-600 p-2 rounded-lg shadow-lg">
                <i data-lucide="chef-hat" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight leading-none">Admin<span class="text-orange-500">Panel</span></h1>
                <span class="text-xs text-slate-400">v2.0.1</span>
            </div>
        </div>

        <nav class="flex-1 p-4 mt-4 overflow-y-auto space-y-2">
            <p class="px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Main Menu</p>
            
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="font-medium">Dashboard</span>
            </button>
            
            <button onclick="switchTab('menu')" id="nav-menu" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white">
                <i data-lucide="utensils-crossed" class="w-5 h-5"></i>
                <span class="font-medium">Menu Manager</span>
            </button>
            
            <button onclick="switchTab('orders')" id="nav-orders" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white">
                <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                <span class="font-medium">Orders</span>
            </button>
            
            <button onclick="switchTab('staff')" id="nav-staff" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span class="font-medium">Staff & Roles</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-700 bg-slate-900">
            <button class="flex items-center space-x-3 text-slate-400 hover:text-white hover:bg-slate-800 transition-all w-full px-4 py-3 rounded-lg group">
                <i data-lucide="log-out" class="w-5 h-5 group-hover:text-red-400 transition-colors"></i>
                <span>Sign Out</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-gray-50/50">
        
        <!-- Mobile Overlay -->
        <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 backdrop-blur-sm hidden md:hidden"></div>

        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 p-4 md:px-8 h-16 shrink-0 flex justify-between items-center z-20 sticky top-0">
            <div class="flex items-center">
                <button onclick="toggleSidebar()" class="md:hidden mr-4 p-2 rounded-md hover:bg-gray-100 text-gray-600">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div id="header-title" class="animate-fade-in-up">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-900">Dashboard Overview</h2>
                </div>
            </div>
            
            <div id="header-actions" class="animate-fade-in-up flex items-center space-x-4">
                <!-- Dynamic Action Button Injected Here -->
                <div class="h-8 w-8 rounded-full bg-orange-100 text-orange-700 flex items-center justify-center font-bold text-sm border-2 border-orange-200">
                    AD
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 max-w-7xl mx-auto w-full space-y-8 pb-20">
            <!-- Dynamic Content Injected Here -->
            <div class="flex justify-center items-center h-64 text-gray-400">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto mb-2"></div>
                    <p>Connecting to System...</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-all duration-300" id="modal-panel">
            <div class="flex justify-between items-center p-5 border-b border-gray-100 bg-gray-50/50">
                <h3 id="modal-title" class="text-lg font-bold text-gray-800">Modal Title</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-200 p-1 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="modal-body" class="p-6">
                <!-- Modal Content Injected Here -->
            </div>
        </div>
    </div>

    <!-- API Logic -->
    <script>
        const API_BASE = '/api';

        const api = {
            currentUser: null,
            getHeaders: () => {
                const headers = { 'Content-Type': 'application/json' };
                if (api.currentUser && api.currentUser.token) {
                    headers['Authorization'] = `Bearer ${api.currentUser.token}`;
                }
                return headers;
            },
            
            // --- Categories ---
            getAllCategories: async () => {
                const response = await fetch(`${API_BASE}/categories/all`); 
                if (!response.ok) return [];
                return await response.json();
            },
            addCategory: async (description) => {
                const response = await fetch(`${API_BASE}/categories/add`, {
                    method: 'POST',
                    headers: api.getHeaders(),
                    body: JSON.stringify({ description: description, name: description }) 
                });
                if (!response.ok) throw new Error("Failed to add category");
                return await response.json();
            },
            deleteCategory: async (id) => {
                const response = await fetch(`${API_BASE}/categories/delete/${id}`, { method: 'DELETE', headers: api.getHeaders() });
                if (!response.ok) throw new Error("Failed to delete category");
            },

            // --- Products ---
            getAllProducts: async () => {
                const response = await fetch(`${API_BASE}/products/all`);
                if (!response.ok) return [];
                return await response.json();
            },
            addProduct: async (productDTO) => {
                const response = await fetch(`${API_BASE}/products/add`, {
                    method: 'POST',
                    headers: api.getHeaders(),
                    body: JSON.stringify(productDTO)
                });
                if (!response.ok) throw new Error('Failed to add product');
                return await response.json();
            },
            deleteProduct: async (id) => {
                const response = await fetch(`${API_BASE}/products/delete/${id}`, { method: 'DELETE', headers: api.getHeaders() });
                if (!response.ok) throw new Error("Failed to delete product");
            },

            // --- Users/Staff ---
            getAllUsers: async () => {
                const response = await fetch(`${API_BASE}/admins/users`, { headers: api.getHeaders() });
                return response.ok ? await response.json() : [];
            },
            addStaffMember: async (userData, roleName) => {
                const response = await fetch(`${API_BASE}/admins/staff?roleName=${roleName}`, {
                    method: 'POST',
                    headers: api.getHeaders(),
                    body: JSON.stringify(userData)
                });
                if (!response.ok) throw new Error('Failed to create staff');
                return await response.json();
            },
            deleteUser: async (id) => {
                const response = await fetch(`${API_BASE}/admins/users/${id}`, { method: 'DELETE', headers: api.getHeaders() });
                if (!response.ok) throw new Error("Failed to delete user");
            }
        };
    </script>

    <!-- Admin Logic -->
    <script>
        let state = {
            activeTab: 'menu',
            isSidebarOpen: false,
            modal: { isOpen: false, type: null, item: null, catId: null },
            categories: [], // Populated from API
            staff: [],      // Populated from API
            orders: [       // Mock orders for demo as API endpoint wasn't provided for all orders
                { id: '#ORD-7782', customer: 'Alice Freeman', total: 45.20, status: 'Cooking', items: 3, time: '12 mins ago' },
                { id: '#ORD-7781', customer: 'Bob Vance', total: 22.50, status: 'Ready', items: 1, time: '25 mins ago' },
                { id: '#ORD-7780', customer: 'Phyllis L.', total: 112.00, status: 'Delivered', items: 8, time: '1 hour ago' },
            ], 
            stats: [
               { label: 'Total Revenue', value: '$12,450', change: '+12%', icon: 'dollar-sign', color: 'bg-emerald-100 text-emerald-600' },
               { label: 'Active Orders', value: '18', change: '-2%', icon: 'clock', color: 'bg-orange-100 text-orange-600' },
               { label: 'Pending Delivery', value: '5', change: '0%', icon: 'shopping-bag', color: 'bg-blue-100 text-blue-600' },
               { label: 'Total Staff', value: '12', change: '+1', icon: 'users', color: 'bg-purple-100 text-purple-600' },
            ]
        };

        // --- INIT & DATA LOADING ---

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
        });

        async function loadAllData() {
            // Load Categories and Products
            try {
                const [cats, prods] = await Promise.all([
                    api.getAllCategories(),
                    api.getAllProducts()
                ]);

                // Map products into categories for the UI structure
                state.categories = cats.map(c => {
                    return {
                        id: c.id,
                        name: c.description || c.name || `Category ${c.id}`, // Fallback for name
                        products: prods.filter(p => p.category && p.category.id === c.id).map(p => ({
                            id: p.id,
                            name: p.name,
                            price: p.price,
                            description: `Product ID: ${p.id}`, // Description wasn't in list endpoint, usually
                            available: p.available,
                            image: p.imageUrl || 'https://via.placeholder.com/300?text=No+Image'
                        }))
                    };
                });
            } catch (e) { console.error("Menu Load Error", e); }

            // Load Staff
            try {
                const users = await api.getAllUsers();
                state.staff = users.map(u => ({
                    id: u.id,
                    name: u.name,
                    email: u.email,
                    role: u.role ? (u.role.roleName || u.role.name) : 'No Role',
                    avatar: u.name ? u.name.substring(0,2).toUpperCase() : 'UR'
                }));
            } catch (e) { console.error("Staff Load Error", e); }

            render();
        }

        // --- RENDER ENGINE ---

        function render() {
            renderSidebar();
            renderHeader();
            renderMainContent();
            lucide.createIcons();
        }

        function renderSidebar() {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.className = 'nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white';
            });
            const activeBtn = document.getElementById('nav-' + state.activeTab);
            if(activeBtn) {
                activeBtn.className = 'nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-200 bg-gradient-to-r from-orange-600 to-orange-500 text-white shadow-lg shadow-orange-500/30';
            }
            // Mobile toggle logic
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (state.isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function renderHeader() {
            const titles = { dashboard: 'Dashboard Overview', menu: 'Menu Management', orders: 'Live Orders', staff: 'Team Members' };
            document.getElementById('header-title').innerHTML = `<h2 class="text-xl md:text-2xl font-bold text-gray-900">${titles[state.activeTab]}</h2>`;

            const actionsDiv = document.getElementById('header-actions');
            let actionHtml = '';

            if (state.activeTab === 'menu') {
                actionHtml = `<button onclick="openModal('addCategory')" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-xl flex items-center space-x-2 shadow-lg shadow-slate-900/20 transition-all text-sm md:text-base"><i data-lucide="folder-plus" class="w-4 h-4 md:w-5 md:h-5"></i><span class="font-medium hidden md:inline">New Category</span></button>`;
            } else if (state.activeTab === 'staff') {
                actionHtml = `<button onclick="openModal('addStaff')" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-xl flex items-center space-x-2 shadow-lg shadow-orange-600/20 transition-all text-sm md:text-base"><i data-lucide="user-plus" class="w-4 h-4 md:w-5 md:h-5"></i><span class="font-medium hidden md:inline">Add Employee</span></button>`;
            }
            actionHtml += `<div class="h-8 w-8 rounded-full bg-orange-100 text-orange-700 flex items-center justify-center font-bold text-sm border-2 border-orange-200">AD</div>`;
            actionsDiv.innerHTML = actionHtml;
        }

        function renderMainContent() {
            const container = document.getElementById('main-content');
            if (state.activeTab === 'dashboard') container.innerHTML = getDashboardHtml();
            else if (state.activeTab === 'menu') container.innerHTML = getMenuHtml();
            else if (state.activeTab === 'orders') container.innerHTML = getOrdersHtml();
            else if (state.activeTab === 'staff') container.innerHTML = getStaffHtml();
        }

        // --- HTML GENERATORS ---

        function getDashboardHtml() {
            const statsHtml = state.stats.map(stat => `
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6 flex items-center justify-between hover:shadow-md transition-shadow">
                    <div><p class="text-sm font-medium text-gray-500 mb-1">${stat.label}</p><h2 class="text-2xl font-bold text-gray-800">${stat.value}</h2><p class="text-xs font-medium mt-2 flex items-center ${stat.change.startsWith('+') ? 'text-emerald-600' : 'text-red-500'}">${stat.change} from last month</p></div>
                    <div class="p-3 rounded-full ${stat.color} bg-opacity-20"><i data-lucide="${stat.icon}" class="w-6 h-6"></i></div>
                </div>`).join('');
            
            return `<div class="space-y-6 animate-fade-in-up"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">${statsHtml}</div>
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-8 text-center"><h3 class="text-lg font-medium text-gray-500">Analytics are currently in demo mode.</h3></div></div>`;
        }

        function getMenuHtml() {
            if (state.categories.length === 0) {
                return `<div class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-200 animate-fade-in-up">
                        <div class="bg-gray-50 p-4 rounded-full inline-block mb-4"><i data-lucide="layout-grid" class="w-8 h-8 text-gray-300"></i></div>
                        <h3 class="text-lg font-medium text-gray-900">No categories found</h3>
                        <p class="text-gray-500 mb-6">Create a category to get started.</p>
                        <button onclick="openModal('addCategory')" class="text-orange-600 font-medium hover:underline">Create Category</button>
                    </div>`;
            }

            return state.categories.map(cat => {
                const cString = JSON.stringify(cat).replace(/"/g, '&quot;');
                
                const productsHtml = cat.products.length === 0 
                    ? `<div onclick="openModal('addProduct', null, '${cat.id}')" class="col-span-full py-12 text-center bg-gray-50/50 rounded-xl border-2 border-dashed border-gray-200 group hover:border-orange-200 transition-colors cursor-pointer">
                        <i data-lucide="plus-circle" class="w-8 h-8 text-gray-300 mx-auto mb-2 group-hover:text-orange-400"></i>
                        <p class="text-gray-400 text-sm group-hover:text-orange-600">Add first product to ${cat.name}</p></div>`
                    : cat.products.map(p => {
                        const pString = JSON.stringify(p).replace(/"/g, '&quot;');
                        return `<div class="group bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl hover:border-orange-100 transition-all duration-300 flex flex-col ${!p.available ? 'opacity-75 grayscale' : ''}">
                            <div class="h-48 w-full bg-gray-100 relative overflow-hidden">
                                <img src="${p.image}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/300?text=No+Image'">
                                <div class="absolute top-3 right-3"><span class="px-2.5 py-1 rounded-md text-xs font-bold shadow-sm backdrop-blur-md ${p.available ? 'bg-white/90 text-green-700' : 'bg-gray-800/90 text-white'}">${p.available ? 'Active' : 'Hidden'}</span></div>
                            </div>
                            <div class="p-5 flex-1 flex flex-col">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-bold text-lg text-gray-800 leading-tight">${p.name}</h3>
                                    <span class="font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-lg text-sm">$${p.price.toFixed(2)}</span>
                                </div>
                                <div class="flex items-center justify-between pt-4 border-t border-gray-50 mt-auto">
                                    <span class="text-xs text-gray-400">ID: ${p.id}</span>
                                    <button onclick="handleDeleteProduct('${p.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                
                return `<div class="mb-10 animate-fade-in-up">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">${cat.name} <span class="text-xs font-semibold bg-gray-200 text-gray-600 px-2.5 py-0.5 rounded-full">${cat.products.length}</span></h3>
                        <div class="flex items-center bg-white rounded-lg border border-gray-200 p-1 shadow-sm">
                            <button onclick="openModal('addProduct', null, '${cat.id}')" class="text-xs font-medium px-3 py-1.5 rounded-md hover:bg-gray-100 text-gray-600 flex items-center gap-1.5"><i data-lucide="plus" class="w-3.5 h-3.5"></i> Add Item</button>
                            <div class="w-px h-4 bg-gray-200 mx-1"></div>
                            <button onclick="handleDeleteCategory('${cat.id}')" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-md"><i data-lucide="trash" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">${productsHtml}</div>
                </div>`;
            }).join('');
        }

        function getStaffHtml() {
            const rows = state.staff.map(emp => {
                const eString = JSON.stringify(emp).replace(/"/g, '&quot;');
                return `<tr class="group hover:bg-orange-50/30 transition-colors border-b border-gray-100 last:border-0">
                    <td class="p-4 pl-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-900 flex items-center justify-center text-white text-sm font-bold shadow-md ring-2 ring-white">${emp.avatar}</div>
                            <div><p class="font-semibold text-gray-900">${emp.name}</p><p class="text-xs text-gray-500">${emp.email}</p></div>
                        </div>
                    </td>
                    <td class="p-4"><span style="background:#f3f4f6; padding:2px 8px; border-radius:4px; font-size:0.9em; font-weight:bold;">${emp.role}</span></td>
                    <td class="p-4 pr-6 text-right">
                        ${emp.role === 'ADMIN' ? '<span class="text-gray-400 text-xs">Protected</span>' : 
                        `<button onclick="handleDeleteStaff('${emp.id}')" class="text-gray-400 hover:text-red-600 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`}
                    </td>
                </tr>`;
            }).join('');
            return `<div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden animate-fade-in-up">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 border-b border-gray-200"><tr><th class="p-4 pl-6 text-xs font-semibold text-gray-500 uppercase">Employee</th><th class="p-4 text-xs font-semibold text-gray-500 uppercase">Role</th><th class="p-4 pr-6 text-right text-xs font-semibold text-gray-500 uppercase">Actions</th></tr></thead>
                    <tbody class="divide-y divide-gray-100">${rows.length ? rows : '<tr><td colspan="3" class="p-10 text-center text-gray-400">No staff found via API.</td></tr>'}</tbody>
                </table>
            </div>`;
        }

        function getOrdersHtml() {
            return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in-up">${state.orders.map(o => `
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5 border-l-4 border-l-orange-500"><div class="flex justify-between items-start mb-4"><div><span class="text-xs font-bold text-gray-400 uppercase">${o.id}</span><h3 class="font-bold text-lg text-gray-800">${o.customer}</h3></div><span class="px-2.5 py-0.5 rounded-full text-xs font-semibold bg-orange-100 text-orange-700">${o.status}</span></div><div class="flex justify-between items-center pt-4 border-t border-gray-100"><span class="font-bold text-xl text-gray-800">$${o.total.toFixed(2)}</span></div></div>`).join('')}</div>`;
        }

        // --- ACTIONS (Connecting to API) ---

        async function handleFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const { type, catId } = state.modal;

            try {
                if (type === 'addStaff') {
                    await api.addStaffMember({
                        name: formData.get('name'),
                        email: formData.get('email'),
                        password: formData.get('password')
                    }, formData.get('role'));
                    alert("Staff Added");
                } 
                else if (type === 'addCategory') {
                    await api.addCategory(formData.get('catName'));
                    alert("Category Added");
                } 
                else if (type === 'addProduct') {
                    await api.addProduct({
                        name: formData.get('name'),
                        price: parseFloat(formData.get('price')),
                        imageUrl: formData.get('image'),
                        categoryId: parseInt(catId),
                        available: true
                    });
                    alert("Product Added");
                }
                closeModal();
                loadAllData(); // Refresh Data
            } catch (err) {
                alert("Operation failed: " + err.message);
            }
        }

        async function handleDeleteCategory(id) {
            if(!confirm("Delete Category?")) return;
            try { await api.deleteCategory(id); loadAllData(); } catch(e) { alert("Error deleting category"); }
        }
        async function handleDeleteProduct(id) {
            if(!confirm("Remove Product?")) return;
            try { await api.deleteProduct(id); loadAllData(); } catch(e) { alert("Error deleting product"); }
        }
        async function handleDeleteStaff(id) {
            if(!confirm("Remove User?")) return;
            try { await api.deleteUser(id); loadAllData(); } catch(e) { alert("Error deleting user"); }
        }

        // --- UTILS ---
        function switchTab(tab) { state.activeTab = tab; state.isSidebarOpen = false; render(); }
        function toggleSidebar() { state.isSidebarOpen = !state.isSidebarOpen; render(); }
        
        function openModal(type, item = null, catId = null) {
            state.modal = { isOpen: true, type, item, catId };
            const container = document.getElementById('modal-container');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            container.classList.remove('hidden');
            setTimeout(() => { 
                container.classList.remove('opacity-0'); 
                document.getElementById('modal-panel').classList.remove('scale-95');
                document.getElementById('modal-panel').classList.add('scale-100');
            }, 10);

            if(type === 'addStaff') {
                title.innerText = 'Add Employee';
                body.innerHTML = `<form onsubmit="handleFormSubmit(event)" class="space-y-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label><input name="name" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label><input name="email" type="email" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label><input name="password" type="password" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Role</label><select name="role" class="w-full px-3 py-2 border rounded-lg bg-white"><option value="STAFF">Kitchen Staff</option><option value="DELIVERY_STAFF">Delivery Driver</option></select></div>
                    <button type="submit" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 mt-2">Create Account</button>
                </form>`;
            } else if (type === 'addCategory') {
                title.innerText = 'New Category';
                body.innerHTML = `<form onsubmit="handleFormSubmit(event)" class="space-y-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description/Name</label><input name="catName" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"></div>
                    <button type="submit" class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700 mt-2">Create Category</button>
                </form>`;
            } else if (type === 'addProduct') {
                title.innerText = 'Add Product';
                body.innerHTML = `<form onsubmit="handleFormSubmit(event)" class="space-y-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label><input name="name" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Price</label><input name="price" type="number" step="0.01" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label><input name="image" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"></div>
                    <button type="submit" class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700 mt-2">Add Product</button>
                </form>`;
            }
        }

        function closeModal() {
            const container = document.getElementById('modal-container');
            container.classList.add('opacity-0');
            setTimeout(() => container.classList.add('hidden'), 300);
        }

    </script>
</body>
</html>